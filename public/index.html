<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta name="Pragma" content="no-cache" />
  <meta name="Expires" content="0" />
  <meta name="description" content="">
  <meta name="keywords" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta name="app-mobile-web-app-capable" content="yes">
  <meta name="app-mobile-web-app-status-bar-style" content="blank">
  <meta name="format-detection" content="telephone=no">
  <title>JS 分段上传Demo</title>
  <style>
    * {
      margin: 0;
      padding: 0;
    }

    body {
      font-size: 18px;
    }
  </style>
</head>

<body>
  <div style="margin:10px auto;">
    <input id="videoKh" type="file" accept="video/*" capture="camcorder">
    <div id="status" style="margin:20px auto;"></div>
    <button onclick="sendRequest()">
      上传
    </button>
  </div>
  <!-- <script src="/npm/static/js/vconsole.min.js"></script> -->


  <script type="text/javascript"> 
    // var vConsole = new window.VConsole()
    // console.log('Hello world' + vConsole)

    var BYTES_PER_CHUNK = 100 * 1024; // 每个文件切片大小定为1MB .
    var slices;
    var totalSlices;

    //发送请求
    function sendRequest() {
      var blob = document.getElementById("videoKh").files[0];
      var start = 0;
      var end;
      var index = 0;

      console.log('文件大小:' + blob.size / 1024 + 'kb')
      // 计算文件切片总数
      slices = Math.ceil(blob.size / BYTES_PER_CHUNK);

      console.log(slices)
      totalSlices = slices;

      console.time('time1')
      while (start < blob.size) {
        console.log(blob.size)
        end = start + BYTES_PER_CHUNK;
        if (end > blob.size) {
          end = blob.size;
        }
        uploadFile(blob, totalSlices, index, start, end);
        console.log(start, end, index)
        start = end;
        index++;
        if (index >= totalSlices) {
          document.getElementById('status').innerHTML = '上传结束'
          console.timeEnd('time1')
        }
      }
    }

    //上传文件
    function uploadFile(blob, total, index, start, end) {
      var xhr;
      var fd;
      var chunk;
      var sliceIndex = blob.name + index;
      chunk = blob.slice(start, end);//切割文件 
      fd = new FormData();
      fd.append("video", chunk, sliceIndex);
      fd.append("total", total)
      fd.append("index", index)
      var xhr = new XMLHttpRequest();
      //false指同步上传，因为我的服务器内存较小，选择同步，如果追求速度，可以选择 //ture，异步上传
      xhr.open('POST', '/img', false);
      xhr.setRequestHeader('content-type', 'application/x-www-form-urlencoded')
      // xhr.open('POST', '/img', true);
      xhr.send(fd);
      if ((xhr.status >= 200 && xhr.status < 300) || xhr.status == 304) {
        setTimeout("", 10);
      } else {
        uploadFile(blob, index, start, end);
      }
    }
  </script>
</body>

</html>
